/* Copyright 2021 Katrina (@PepperKats)
 * Copyright 2023 KernelEquinox (@KernelEquinox)
 *
 * OLED design and animation created by ScruffyTheDeer.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */



#include "quantum.h"

// OLED code ahead
#ifdef OLED_ENABLE

// Layer ID data
#define NUM_LAYERS                  4
#define LAYER_SIZE                  10 * 3

// Frame data
#define NUM_FRAMES                  7
#define FRAME_SIZE                  20 * 16

// Top checkbox offset (Caps Lock)
#define TOP_CHECKBOX_ROW            7
#define TOP_CHECKBOX_COLUMN         8
#define TOP_CHECKBOX_OFFSET         (TOP_CHECKBOX_ROW * 0x10) + TOP_CHECKBOX_COLUMN

// Bottom checkbox offset (Num Lock)
#define BOTTOM_CHECKBOX_ROW         23
#define BOTTOM_CHECKBOX_COLUMN      8
#define BOTTOM_CHECKBOX_OFFSET      (BOTTOM_CHECKBOX_ROW * 0x10) + BOTTOM_CHECKBOX_COLUMN

// Change this to modify the timeout (default: 20 seconds)
#define TIMEOUT_SECONDS             20
#define TIMEOUT                     TIMEOUT_SECONDS * 1000




static uint32_t timeout_time = 0;   // OLED deactivation timer
static uint32_t frame_time = 0;     // Animation frame timer
static uint8_t cur_frame = 0;       // Current frame counter
static bool oled_active = true;     // OLED activation flag




// Renders the main UI displayed on the OLED
static void render_ui(void) {

    // These determine whether the upper portion or lower portion of the buffer should be modified
    static const uint8_t offsets[NUM_FRAMES] = {
        0xC0,   // 1 -> 2
        0x20,   // 2 -> 3
        0x20,   // 3 -> 4
        0x20,   // 4 -> 5
        0xC0,   // 5 -> 6
        0x20,   // 6 -> 7
        0xC0,   // 7 -> 1
    };

    // Animation frame data
    //
    // Note:
    //     Only 20 lines are modified to reduce the size of the firmware image.
    //     This also works great for animations that update 20 lines or fewer at a time.
    //
    static const char PROGMEM frames[NUM_FRAMES][FRAME_SIZE] = {
        {   // Frame 2
            0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xc1, 0x9f, 0x3f, 0x3f, 0x1f, 0x03, 0x03, 0x03, 0x03, 0x86, 
            0xc6, 0xfe, 0x3c, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x20, 0x21, 0x2f, 0xa8, 0x20, 0x20, 0x40, 0x40, 
            0x80, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
            0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
            0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
            0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0x02, 0x9a, 
            0xa2, 0xc2, 0x82, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 
            0x06, 0x03, 0x03, 0x01, 0x00, 0x38, 0x64, 0x40, 0x40, 0x40, 0x20, 0x20, 0x10, 0x10, 0x20, 0x20, 
            0x40, 0x40, 0x40, 0x64, 0x38, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x06, 0x03, 0x03, 
            0x01, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x82, 0xc2, 0xa2, 0x9a, 0x02, 0x04, 0x08, 0x10, 0x00, 
            0x00, 0x00, 0x3f, 0x02, 0x04, 0x08, 0x3f, 0x00, 0x1f, 0x20, 0x20, 0x20, 0x1f, 0x00, 0x3f, 0x01, 
            0x06, 0x01, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x3f, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x10, 0x08, 0x04, 0x02, 0x02, 0x01, 0x01, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0xc0, 0x01, 0x01, 0x01, 0x12, 0xe2, 0x04, 0x08, 0x30, 
            0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x30, 0x08, 0x04, 0xe2, 0x12, 0x01, 
            0x01, 0x01, 0xc0, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x02, 0x04, 
            0x08, 0x10, 0x60, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {   // Frame 3
            0xff, 0x00, 0x00, 0x1f, 0x10, 0x0c, 0x02, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 
            0x80, 0x88, 0x88, 0xd0, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xd0, 0x88, 0x88, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x01, 0x03, 0x02, 0x0c, 0x10, 0x1f, 0x00, 0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0xf8, 0x04, 0x04, 0x04, 0x88, 0x00, 0xf0, 0x48, 0x44, 0x48, 0xf0, 0x00, 0xfc, 0x24, 
            0x24, 0x24, 0x18, 0x00, 0x00, 0x00, 0xfc, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0xfc, 0x00, 
            0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x40, 0x20, 0x20, 0x10, 0x10, 0x54, 0x17, 
            0x10, 0x10, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x3c, 0xfe, 0xc6, 0x86, 0x03, 0x03, 0x03, 0x03, 0x1f, 
            0x3f, 0x3f, 0x9f, 0xc1, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xc1, 0x9f, 0x3f, 0x3f, 0x1f, 0x03, 0x03, 0x03, 0x03, 0x86, 
            0xc6, 0xfe, 0x3c, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x10, 0x10, 0x17, 0x54, 0x10, 0x10, 0x20, 0x20, 
            0x40, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
            0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
            0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
            0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x08, 0x04, 0x02, 0x01, 0x8d, 
            0x91, 0xa1, 0xc1, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 
            0x06, 0x03, 0x03, 0x01, 0x00, 0x38, 0x64, 0x40, 0x40, 0x40, 0x20, 0x20, 0x10, 0x10, 0x20, 0x20, 
            0x40, 0x40, 0x40, 0x64, 0x38, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x06, 0x03, 0x03, 
            0x01, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0xc1, 0xa1, 0x91, 0x8d, 0x01, 0x02, 0x04, 0x08, 0x00
        },
        {   // Frame 4
            0xff, 0x00, 0x00, 0x1f, 0x10, 0x0c, 0x02, 0x03, 0x01, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0xc0, 
            0xc0, 0xc4, 0xc4, 0xe8, 0xe0, 0xe0, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x60, 0xe0, 0xe0, 0xe8, 0xc4, 0xc4, 0xc0, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x00, 
            0x00, 0x01, 0x03, 0x02, 0x0c, 0x10, 0x1f, 0x00, 0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0xf8, 0x04, 0x04, 0x04, 0x88, 0x00, 0xf0, 0x48, 0x44, 0x48, 0xf0, 0x00, 0xfc, 0x24, 
            0x24, 0x24, 0x18, 0x00, 0x00, 0x00, 0xfc, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0xfc, 0x00, 
            0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x40, 0x20, 0x20, 0x10, 0x10, 0x54, 0x17, 
            0x10, 0x10, 0x00, 0x00, 0x00, 0x06, 0x06, 0x1e, 0x7f, 0xe3, 0xc3, 0x81, 0x01, 0x01, 0x01, 0x0f, 
            0x1f, 0x9f, 0xcf, 0xe0, 0x7f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xe0, 0xcf, 0x9f, 0x1f, 0x0f, 0x01, 0x01, 0x01, 0x81, 0xc3, 
            0xe3, 0x7f, 0x1e, 0x06, 0x06, 0x00, 0x00, 0x00, 0x10, 0x10, 0x17, 0x54, 0x10, 0x10, 0x20, 0x20, 
            0x40, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
            0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
            0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
            0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x08, 0x04, 0x02, 0x01, 0x8d, 
            0x91, 0xa1, 0xc1, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 
            0x03, 0x01, 0x01, 0x00, 0x00, 0x38, 0x64, 0x40, 0x40, 0x40, 0x20, 0x20, 0x10, 0x10, 0x20, 0x20, 
            0x40, 0x40, 0x40, 0x64, 0x38, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 
            0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0xc1, 0xa1, 0x91, 0x8d, 0x01, 0x02, 0x04, 0x08, 0x00
        },
        {   // Frame 5
            0xff, 0x00, 0x00, 0x3f, 0x20, 0x18, 0x04, 0x06, 0x03, 0x01, 0x01, 0x80, 0x80, 0x80, 0x80, 0xc0, 
            0xc0, 0xc4, 0xc4, 0xe8, 0xe0, 0xe0, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x60, 0xe0, 0xe0, 0xe8, 0xc4, 0xc4, 0xc0, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x01, 
            0x01, 0x03, 0x06, 0x04, 0x18, 0x20, 0x3f, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0xf8, 0x04, 0x04, 0x04, 0x88, 0x00, 0xf0, 0x48, 0x44, 0x48, 0xf0, 0x00, 0xfc, 0x24, 
            0x24, 0x24, 0x18, 0x00, 0x00, 0x00, 0xfc, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0xfc, 0x00, 
            0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x80, 0x40, 0x40, 0x20, 0x20, 0xa8, 0x2f, 
            0x21, 0x20, 0x00, 0x00, 0x00, 0x06, 0x06, 0x1e, 0x7f, 0xe3, 0xc3, 0x81, 0x01, 0x01, 0x01, 0x0f, 
            0x1f, 0x9f, 0xcf, 0xe0, 0x7f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xe0, 0xcf, 0x9f, 0x1f, 0x0f, 0x01, 0x01, 0x01, 0x81, 0xc3, 
            0xe3, 0x7f, 0x1e, 0x06, 0x06, 0x00, 0x00, 0x00, 0x20, 0x21, 0x2f, 0xa8, 0x20, 0x20, 0x40, 0x40, 
            0x80, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
            0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
            0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
            0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0x02, 0x9a, 
            0xa2, 0xc2, 0x82, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 
            0x03, 0x01, 0x01, 0x00, 0x00, 0x1c, 0x32, 0x20, 0x20, 0x20, 0x10, 0x10, 0x08, 0x08, 0x10, 0x10, 
            0x20, 0x20, 0x20, 0x32, 0x1c, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 
            0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x82, 0xc2, 0xa2, 0x9a, 0x02, 0x04, 0x08, 0x10, 0x00
        },
        {   // Frame 6
            0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xe0, 0xcf, 0x9f, 0x1f, 0x0f, 0x01, 0x01, 0x01, 0x81, 0xc3, 
            0xe3, 0x7f, 0x1e, 0x06, 0x06, 0x00, 0x00, 0x00, 0x20, 0x21, 0x2f, 0xa8, 0x20, 0x20, 0x40, 0x40, 
            0x80, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
            0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
            0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
            0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0x02, 0x1a, 
            0x22, 0x42, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 
            0x03, 0x01, 0x01, 0x00, 0x00, 0x1c, 0x32, 0x20, 0x20, 0x20, 0x10, 0x10, 0x08, 0x08, 0x10, 0x10, 
            0x20, 0x20, 0x20, 0x32, 0x1c, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x82, 0x42, 0x22, 0x1a, 0x02, 0x04, 0x08, 0x10, 0x00, 
            0x00, 0x00, 0x3f, 0x02, 0x04, 0x08, 0x3f, 0x00, 0x1f, 0x20, 0x20, 0x20, 0x1f, 0x00, 0x3f, 0x01, 
            0x06, 0x01, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x3f, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x20, 0x10, 0x08, 0x04, 0x04, 0x02, 0x02, 0x01, 
            0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x41, 0x81, 0x02, 0x02, 0x02, 0x24, 0xc4, 0x08, 0x10, 0x60, 
            0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x10, 0x08, 0xc4, 0x24, 0x02, 
            0x02, 0x02, 0x81, 0x41, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x08, 
            0x10, 0x20, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {   // Frame 7
            0xff, 0x00, 0x00, 0x3f, 0x20, 0x18, 0x04, 0x06, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x80, 
            0x80, 0x88, 0x88, 0xd0, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xd0, 0x88, 0x88, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 
            0x01, 0x03, 0x06, 0x04, 0x18, 0x20, 0x3f, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0xf8, 0x04, 0x04, 0x04, 0x88, 0x00, 0xf0, 0x48, 0x44, 0x48, 0xf0, 0x00, 0xfc, 0x24, 
            0x24, 0x24, 0x18, 0x00, 0x00, 0x00, 0xfc, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0xfc, 0x00, 
            0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x80, 0x40, 0x40, 0x20, 0x20, 0xa8, 0x2f, 
            0x21, 0x20, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x3c, 0xfe, 0xc6, 0x86, 0x03, 0x03, 0x03, 0x03, 0x1f, 
            0x3f, 0x3f, 0x9f, 0xc1, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xc1, 0x9f, 0x3f, 0x3f, 0x1f, 0x03, 0x03, 0x03, 0x03, 0x86, 
            0xc6, 0xfe, 0x3c, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x20, 0x21, 0x2f, 0xa8, 0x20, 0x20, 0x40, 0x40, 
            0x80, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
            0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
            0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
            0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0x02, 0x1a, 
            0x22, 0x42, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 
            0x06, 0x03, 0x03, 0x01, 0x00, 0x1c, 0x32, 0x20, 0x20, 0x20, 0x10, 0x10, 0x08, 0x08, 0x10, 0x10, 
            0x20, 0x20, 0x20, 0x32, 0x1c, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x06, 0x03, 0x03, 
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x82, 0x42, 0x22, 0x1a, 0x02, 0x04, 0x08, 0x10, 0x00
        },
        {   // Frame 1
            0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xc1, 0x9f, 0x3f, 0x3f, 0x1f, 0x03, 0x03, 0x03, 0x03, 0x86, 
            0xc6, 0xfe, 0x3c, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x20, 0x21, 0x2f, 0xa8, 0x20, 0x20, 0x40, 0x40, 
            0x80, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
            0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
            0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
            0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0x02, 0x1a, 
            0x22, 0x42, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 
            0x06, 0x03, 0x03, 0x01, 0x00, 0x38, 0x64, 0x40, 0x40, 0x40, 0x20, 0x20, 0x10, 0x10, 0x20, 0x20, 
            0x40, 0x40, 0x40, 0x64, 0x38, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x06, 0x03, 0x03, 
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x82, 0x42, 0x22, 0x1a, 0x02, 0x04, 0x08, 0x10, 0x00, 
            0x00, 0x00, 0x3f, 0x02, 0x04, 0x08, 0x3f, 0x00, 0x1f, 0x20, 0x20, 0x20, 0x1f, 0x00, 0x3f, 0x01, 
            0x06, 0x01, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x3f, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x20, 0x10, 0x08, 0x04, 0x04, 0x02, 0x02, 0x01, 
            0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x41, 0x81, 0x02, 0x02, 0x02, 0x24, 0xc4, 0x08, 0x10, 0x60, 
            0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x10, 0x08, 0xc4, 0x24, 0x02, 
            0x02, 0x02, 0x81, 0x41, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x08, 
            0x10, 0x20, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        }
    };

    // Buffer for the main UI
    static char oled_buffer[] = {
        0x00, 0xfc, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 
        0x02, 0x02, 0x02, 0x02, 0x02, 0x06, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0xff, 0x00, 0x00, 0x3f, 0x20, 0x18, 0x04, 0x06, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x80, 
        0x80, 0x88, 0x88, 0xd0, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xd0, 0x88, 0x88, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 
        0x01, 0x03, 0x06, 0x04, 0x18, 0x20, 0x3f, 0x00, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0xf8, 0x04, 0x04, 0x04, 0x88, 0x00, 0xf0, 0x48, 0x44, 0x48, 0xf0, 0x00, 0xfc, 0x24, 
        0x24, 0x24, 0x18, 0x00, 0x00, 0x00, 0xfc, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0xfc, 0x00, 
        0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x80, 0x40, 0x40, 0x20, 0x20, 0xa8, 0x2f, 
        0x21, 0x20, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x3c, 0xfe, 0xc6, 0x86, 0x03, 0x03, 0x03, 0x03, 0x1f, 
        0x3f, 0x3f, 0x9f, 0xc1, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xc1, 0x9f, 0x3f, 0x3f, 0x1f, 0x03, 0x03, 0x03, 0x03, 0x86, 
        0xc6, 0xfe, 0x3c, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x20, 0x21, 0x2f, 0xa8, 0x20, 0x20, 0x40, 0x40, 
        0x80, 0x00, 0x80, 0x01, 0x01, 0x01, 0x80, 0x00, 0x81, 0x00, 0x00, 0x00, 0x81, 0x00, 0x81, 0x00, 
        0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x81, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x81, 0x00, 
        0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
        0x40, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0x02, 0x1a, 
        0x22, 0x42, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 
        0x06, 0x03, 0x03, 0x01, 0x00, 0x38, 0x64, 0x40, 0x40, 0x40, 0x20, 0x20, 0x10, 0x10, 0x20, 0x20, 
        0x40, 0x40, 0x40, 0x64, 0x38, 0x00, 0x01, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x06, 0x03, 0x03, 
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x82, 0x42, 0x22, 0x1a, 0x02, 0x04, 0x08, 0x10, 0x00, 
        0x00, 0x00, 0x3f, 0x02, 0x04, 0x08, 0x3f, 0x00, 0x1f, 0x20, 0x20, 0x20, 0x1f, 0x00, 0x3f, 0x01, 
        0x06, 0x01, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x3f, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x20, 0x10, 0x08, 0x04, 0x04, 0x02, 0x02, 0x01, 
        0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x41, 0x81, 0x02, 0x02, 0x02, 0x24, 0xc4, 0x08, 0x10, 0x60, 
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x10, 0x08, 0xc4, 0x24, 0x02, 
        0x02, 0x02, 0x81, 0x41, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x08, 
        0x10, 0x20, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };


    // Layer ID numbers
    //
    // Note:
    //     These are inserted as 3 groups of 10 bytes at offsets 0x7, 0x87, and 0x107 respectively.
    //
    static const char PROGMEM layer_numbers[NUM_LAYERS][LAYER_SIZE] = {
        {   // 1
            0x02, 0x02, 0x02, 0x62, 0xf2, 0xf2, 0x02, 0x02, 0x02, 0x02,
            0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
            0x40, 0x40, 0x40, 0x4c, 0x4f, 0x4f, 0x4c, 0x40, 0x40, 0x40
        },
        {   // 2
            0xc2, 0xe2, 0x72, 0x32, 0x32, 0x32, 0x32, 0x72, 0xe2, 0xc2,
            0x01, 0x81, 0xc0, 0xe0, 0x70, 0x38, 0x1c, 0x0e, 0x07, 0x03,
            0x4f, 0x4f, 0x4f, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4e, 0x4e
        },
        {   // 3
            0x72, 0x72, 0x32, 0x32, 0x32, 0x32, 0xb2, 0xf2, 0xf2, 0x72,
            0x00, 0x00, 0x18, 0x1c, 0x1e, 0x1f, 0x3b, 0x71, 0xe0, 0xc0,
            0x43, 0x47, 0x4e, 0x4c, 0x4c, 0x4c, 0x4c, 0x4e, 0x47, 0x43
        },
        {   // 4
            0x02, 0x02, 0x02, 0xe2, 0xe2, 0x02, 0x02, 0xf2, 0xf2, 0x02,
            0x7c, 0x7e, 0x67, 0x63, 0x61, 0x60, 0x60, 0xff, 0xff, 0x60,
            0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x4c, 0x4f, 0x4f, 0x4c
        }
    };



    // Bail if timeout occurred
    if (timer_elapsed32(timeout_time) > TIMEOUT) {
        oled_off();
        oled_active = false;
        return;
    }

    // Display the next frame every 200ms
    if (timer_elapsed32(frame_time) > 200) {
        memcpy_P(&oled_buffer[offsets[cur_frame]], &frames[cur_frame][0], FRAME_SIZE);
        cur_frame = (cur_frame + 1) % NUM_FRAMES;
        frame_time = timer_read32();
    }

    // Set the current layer indicator
    uint8_t cur_layer = get_highest_layer(layer_state);
    if (cur_layer >= 0 && cur_layer < 4) {
        memcpy_P(&oled_buffer[7], &layer_numbers[cur_layer][0], 10);
        memcpy_P(&oled_buffer[0x87], &layer_numbers[cur_layer][10], 10);
        memcpy_P(&oled_buffer[0x107], &layer_numbers[cur_layer][20], 10);
    }

    // Set NUM/CAPS checkboxes
    led_t led_state = host_keyboard_led_state();
    memset(oled_buffer + TOP_CHECKBOX_OFFSET, (led_state.caps_lock ? 0xFA : 0x02), 5);
    memset(oled_buffer + BOTTOM_CHECKBOX_OFFSET, (led_state.num_lock ? 0x5F : 0x40), 5);

    // Draw the UI
    oled_set_cursor(0, 0);
    oled_write_raw(oled_buffer, 512);
}

bool oled_task_kb(void) {

    if (!oled_task_user()) {
        return false;
    }

    // Only render the UI if OLED is active
    if (oled_active) {
        render_ui();
        oled_render();
    }

    return false;
}

// Process key events
bool process_record_user(uint16_t keycode, keyrecord_t *record) {

    // Reset timeout if any key was pressed
    if (record->event.pressed) {
        oled_on();
        oled_active = true;
        timeout_time = timer_read32();
    }

    return true;
};
#endif